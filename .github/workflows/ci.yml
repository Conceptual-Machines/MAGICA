name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  build-docker-image:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build and export Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        tags: magda-build:latest
        outputs: type=docker,dest=/tmp/magda-build.tar
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Upload Docker image artifact
      uses: actions/upload-artifact@v4
      with:
        name: magda-build-image
        path: /tmp/magda-build.tar
        retention-days: 1

  build-and-test-linux:
    runs-on: ubuntu-latest
    needs: build-docker-image

    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Download Docker image artifact
      uses: actions/download-artifact@v4
      with:
        name: magda-build-image
        path: /tmp

    - name: Load Docker image
      run: docker load --input /tmp/magda-build.tar

    - name: Configure CMake in Docker
      run: |
        docker run --rm -v $PWD:/workspace magda-build:latest \
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Debug \
            -DCMAKE_EXPORT_COMPILE_COMMANDS=ON \
            -DMAGDA_BUILD_TESTS=ON

    - name: Build in Docker
      run: |
        docker run --rm -v $PWD:/workspace magda-build:latest \
          bash -c 'echo "Building with $(nproc) cores..." && cmake --build build --config Debug -j$(nproc) -- -v'

    - name: Check build artifacts
      run: |
        echo "Checking build directory structure:"
        ls -la build/tests/ || echo "tests directory not found"
        find build -name "magda_tests" -type f || echo "magda_tests executable not found"

    - name: Run tests in Docker
      run: |
        if [ -f build/tests/magda_tests ]; then
          echo "Running tests..."
          docker run --rm -v $PWD:/workspace magda-build:latest \
            ./build/tests/magda_tests
        else
          echo "❌ Tests executable not found at build/tests/magda_tests"
          echo "Build directory contents:"
          find build -type f -name "*test*" || true
          exit 1
        fi

    - name: Test summary
      if: success()
      run: |
        echo "✅ Build and tests completed successfully on Linux"

  code-quality:
    runs-on: ubuntu-latest
    needs: build-docker-image

    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Download Docker image artifact
      uses: actions/download-artifact@v4
      with:
        name: magda-build-image
        path: /tmp

    - name: Load Docker image
      run: docker load --input /tmp/magda-build.tar

    - name: Check code formatting
      run: |
        docker run --rm -v $PWD:/workspace magda-build:latest \
          bash -c '
            echo "Checking code formatting with clang-format..."
            find magda/daw magda/agents tests -name "*.cpp" -o -name "*.hpp" -o -name "*.h" 2>/dev/null | \
              xargs clang-format --dry-run --Werror 2>&1 | tee format-check.log || true

            if grep -q "warning:" format-check.log; then
              echo "❌ Format check found issues"
              echo "Run make format to fix formatting issues"
              exit 1
            else
              echo "✅ Format check passed!"
            fi
          '
